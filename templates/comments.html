<form id="comments-search-form" class="row" action="/dashboard/comments/search" method="GET" style="margin-bottom: 12px;">
  <input type="hidden" name="survey_id" value="{{ survey.id }}"/>

  <!-- Área -->
  <div class="input-field col s12 m4">
    <select id="search-area" name="area">
      {% if selected_area == 0 %}
        <option value="0" selected>Todas</option>
      {% else %}
        <option value="0">Todas</option>
      {% endif %}
      
      {% for a in areas %}
        <option value="{{ a.area_id }}"
                {% if selected_area|int == a.area_id|int %}selected{% endif %}>
          {{ a.area_name }}
        </option>
      {% endfor %}

    </select>
    <label for="search-area">Área</label>
  </div>

  <!-- Intenção -->
  <div class="input-field col s12 m4">
    <select id="search-intention" name="intention">
      {% if selected_intention == "all" %}
        <option value="all" selected> Todas </option>
      {% else %}
        <option value="all"> Todas </option>
      {% endif %}

      {% if selected_intention == "Reconhecimento" %}
        <option value="Reconhecimento" selected> Reconhecimento </option>
      {% else %}
        <option value="Reconhecimento"> Reconhecimento </option>
      {% endif %}

      {% if selected_intention == "Crítica" %}
        <option value="Crítica" selected> Crítica </option>
      {% else %}
        <option value="Crítica"> Crítica </option>
      {% endif %}

      {% if selected_intention == "Sugestão" %}
        <option value="Sugestão" selected> Sugestão </option>
      {% else %}
        <option value="Sugestão"> Sugestão </option>
      {% endif %}

      {% if selected_intention == "Neutro" %}
        <option value="Neutro" selected> Neutro </option>
      {% else %}
        <option value="Neutro"> Neutro </option>
      {% endif %}

    </select>
    <label for="search-intention">Intenção</label>
  </div>

  <!-- Tema -->
  <div class="input-field col s12 m4">
    <select id="search-theme" name="theme">
      {% if selected_theme == "all" %}
        <option value="all" selected> Todos </option>
      {% else %}
        <option value="all"> Todos </option>
      {% endif %}

      {% for t in themes %}
        <option value="{{ t }}"
                {% if selected_theme == t %}selected{% endif %}>
          {{ t }}
        </option>
      {% endfor %}

    </select>
    <label for="search-theme">Tema</label>
  </div>

  <div class="col s12 right-align" style="margin-top: 8px;">
    <button type="submit" class="btn waves-effect blue">Buscar</button>
  </div>
</form>

{# resumo (chips) #}
{% set ns = namespace(total_perceptions=0) %}
{% for r in rows %}
  {% set ns.total_perceptions = ns.total_perceptions + (r.perceptions|length if r.perceptions is defined else 0) %}
{% endfor %}

<div class="row" style="margin-bottom:12px;">
  <div class="col s12">
    <span class="chip">Comentários: {{ rows|length }}</span>
    <span class="chip blue lighten-5 blue-text text-darken-2">Percepções: {{ ns.total_perceptions }}</span>
  </div>
</div>

{% if themes_intents_data %}
<div class="row" style="margin-top: 40px;">
    <div class="col s12">
        <div id="themes-intents-chart" style="width: 100%; height: 500px;"></div>
    </div>
</div>
<script type="application/json" id="themes-intents-data">
    {{ themes_intents_data | tojson }}
</script>
{% endif %}

<ul class="collection">
  {% for r in rows %}
  <li class="collection-item">
    <div class="grey-text text-darken-1" style="font-size:12px;">
      {% if r.question_name %}Pergunta: <strong>{{ r.question_name }}</strong> • {% endif %}
      Comentário #{{ r.comment_id }}
    </div>

    <p style="margin:6px 0 10px;">{{ r.comment }}</p>

    {% if r.perceptions and r.perceptions|length %}
      {# chips com tema + intenção #}
      <div style="margin:6px 0;">
        {% for p in r.perceptions %}
          {% set intent = (p.perception_intension or 'indefinido')|lower %}
          {% set bg = 'green lighten-5' if intent == 'positivo' else 'red lighten-5' if intent == 'negativo' else 'grey lighten-4' %}
          {% set fg = 'green-text text-darken-2' if intent == 'positivo' else 'red-text text-darken-2' if intent == 'negativo' else 'grey-text text-darken-2' %}
          <span class="chip {{ bg }} {{ fg }}" style="margin-right:4px;">
            {{ p.perception_theme }} • {{ intent|capitalize }}
          </span>
        {% endfor %}
      </div>

      {# lista detalhada das percepções #}
      <ul class="collection" style="margin-top:8px;">
        {% for p in r.perceptions %}
          <li class="collection-item" style="padding:10px 12px;">
            <i class="material-icons tiny" style="vertical-align:middle;margin-right:4px;">label</i>
            <strong>{{ p.perception_theme }}</strong>
            <span class="grey-text">— {{ (p.perception_intension or 'Indefinido')|capitalize }}</span>
            {% if p.perception_comment_clipping %}
              <blockquote class="grey lighten-4" style="margin:6px 0 0; padding:6px 10px;">
                {{ p.perception_comment_clipping }}
              </blockquote>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <span class="grey-text">Sem percepções para este comentário.</span>
    {% endif %}
  </li>
  {% else %}
  <li class="collection-item grey-text">Nenhum comentário encontrado para esta pesquisa.</li>
  {% endfor %}
</ul>